<!DOCTYPE html>
<html>
<link rel="stylesheet" type="text/css" href="GoogleMap.css">
<link rel="stylesheet" type="text/css" href="weather.css">
<body>

<h1>Google Map</h1>

<div id="googleMap_marker"></div>
<input type="checkbox" id="heatmap_checkbox"  onclick="drawHeatmap(this);">
<label for="heatmap_checkbox">Show heatmap</label>
<div id="weather"></div>

<script>
var map = null;
var heatmap = null;

<!--This function is to get Google Map-->
function myMap() {
var mapProp= {
  center:new google.maps.LatLng(51.508742,-0.120850),
  zoom:5,
};
map = new google.maps.Map(document.getElementById("googleMap_marker"),mapProp);
getStations();
getWeather();
// Select the checkbox element using document.querySelector
  var checkbox = document.querySelector('#heatmap_checkbox');

  // Add a click event listener to the checkbox
}

<!--This function is to add markers on the Google Map-->
function addMarkers(stations) {
  stations.forEach(station => {
    var marker = new google.maps.Marker({
      position: {lat: parseFloat(station.position_lat), lng: parseFloat(station.position_lng)},
      map: map,
      title: station.name,
      station_number: station.number,
    });

    // Add mouseover and mouseout event listeners
    marker.addListener('mouseover', function() {
      marker.setAnimation(google.maps.Animation.BOUNCE);
    });

    marker.addListener('mouseout', function() {
      marker.setAnimation(null);
    });
  });
}

function getStations() {
    fetch("/stations")
     .then((response) => response.json())
            .then((data) => {
                console.log("data is:", typeof data);
                addMarkers(data);})
}

<!--This part is displayed weather information vertically-->
function getWeather() {
  fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=53.3498006&lon=-6.2602964&units=metric&appid=8f2e40db6b1c4dcc89b68735362dbc56`)
    .then(response => response.json())
    .then(data => {
      const forecast = data.list;
      const currentTemp = data.list[0].main.temp;
      const currentWeatherMain = data.list[0].weather[0].main;
      const currentWeatherIcon = data.list[0].weather[0].icon;

      // code to display current weather data
      const weatherDiv = document.getElementById("weather");
      weatherDiv.classList.add("animated-bg");

      // Add weather condition class to the weather div
      if (currentWeatherMain.includes('Cloud')) {
        weatherDiv.classList.add('cloudy');
      } else if (currentWeatherMain.includes('Rain')) {
        weatherDiv.classList.add('rainy');
      } else if (currentWeatherMain.includes('Snow')) {
        weatherDiv.classList.add('snowy');
      } else if (currentWeatherMain.includes('Clear')) {
        weatherDiv.classList.add('sunny');
      }

      weatherDiv.innerHTML = `
        <div class="weather-border">
          <div class="weather-header">Current Weather</div>
          <div class="weather-content">
            <img src="https://openweathermap.org/img/wn/${currentWeatherIcon}@2x.png" alt="${currentWeatherMain}" class="icon">
            ${currentTemp} &#8451;, ${currentWeatherMain}
          </div>
        </div>
        <div class="dropdown">
          <button class="dropbtn">Few Hours Forecast</button>
          <div class="dropdown-content">
            ${forecast.slice(0, 6).map((data) => {
              const time = new Date(data.dt * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
              const temp = data.main.temp;
              const weatherMain = data.weather[0].main;
              const weatherIcon = data.weather[0].icon;
              return `
                <div style="font-size: 14px;" class="weather-content">
                  <div>${time}</div>
                  <img src="https://openweathermap.org/img/wn/${weatherIcon}.png" alt="${weatherMain}">
                  <div>${temp} &#8451;, ${weatherMain}</div>
                </div>
              `;
            }).join('')}
          </div>
        </div>

        <!--  More details part-->
        <div class="dropdown">
          <button class="dropbtn">Current Weather More Details</button>
            <div class="dropdown-content">
              <a href="#">Temperature: ${currentTemp} &#8451;</a>
              <a href="#" class="details">Feels Like: ${forecast[0].main.feels_like} &#8451;</a>
              <a href="#" class="details">Humidity: ${forecast[0].main.humidity}%</a>
              <a href="#" class="details">Wind Direction: ${forecast[0].wind.deg} deg</a>
              <a href="#" class="details">Wind Speed: ${forecast[0].wind.speed} m/s</a>
            </div>
          </div>

        <!-- 5-day forecast-->
        <div class="dropdown">
          <button class="dropbtn">5-Day Forecast</button>
          <div class="dropdown-content">
            ${forecast.map((data, index) => {
              if (index % 8 === 0) {
                const date = new Date(data.dt_txt).toLocaleDateString();
                const temp = data.main.temp;
                const weatherMain = data.weather[0].main;
                const weatherIcon = data.weather[0].icon;
                return `
                  <a href="#" class = "weather-date">${date}</a>
                  <div class="weather-content">
                    <img src="https://openweathermap.org/img/wn/${weatherIcon}.png" alt="${weatherMain}">
                    <a href="#" class="details">Temperature: ${temp} &#8451;</a>
                    <a href="#" class="details">Weather: ${weatherMain}</a>
                  </div>
                `;
              }
            }).join('')}
          </div>
        </div>`;
      const dropdowns = document.querySelectorAll(".dropdown");
      const details = document.querySelectorAll(".details");

      dropdowns.forEach(dropdown => {
        dropdown.addEventListener("click", function() {
          this.nextElementSibling.classList.toggle("show");
        });
      });

      details.forEach(detail => {
        detail.addEventListener("click", function(event) {
          event.stopPropagation();
        });
      });

      window.onclick = function(event) {
        if (!event.target.matches('.dropbtn')) {
          const dropdownContent = document.querySelectorAll(".dropdown-content");
          dropdownContent.forEach(content => {
            if (content.classList.contains('show')) {
              content.classList.remove('show');
            }
          });
        }
      };
    });
}


<!--This part is horizontal screen display weather information-->
<!--function getWeather() {-->
<!--  fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=53.3498006&lon=-6.2602964&units=metric&appid=8f2e40db6b1c4dcc89b68735362dbc56`)-->
<!--    .then(response => response.json())-->
<!--    .then(data => {-->
<!--      const forecast = data.list;-->
<!--      const currentTemp = data.list[0].main.temp;-->
<!--      const currentWeatherMain = data.list[0].weather[0].main;-->
<!--      const currentWeatherIcon = data.list[0].weather[0].icon;-->

<!--      // code to display current weather data-->
<!--      const weatherDiv = document.getElementById("weather");-->
<!--      weatherDiv.classList.add("animated-bg");-->

<!--      // Add weather condition class to the weather div-->
<!--      if (currentWeatherMain.includes('Cloud')) {-->
<!--        weatherDiv.classList.add('cloudy');-->
<!--      } else if (currentWeatherMain.includes('Rain')) {-->
<!--        weatherDiv.classList.add('rainy');-->
<!--      } else if (currentWeatherMain.includes('Snow')) {-->
<!--        weatherDiv.classList.add('snowy');-->
<!--      } else if (currentWeatherMain.includes('Clear')) {-->
<!--        weatherDiv.classList.add('sunny');-->
<!--      }-->

<!--      weatherDiv.innerHTML = `-->
<!--        <div id="weather" class="animated-bg">-->
<!--          <div class="weather-header">Current Weather</div>-->
<!--          <div class="weather-content">-->
<!--            <img src="https://openweathermap.org/img/wn/${currentWeatherIcon}.png" alt="${currentWeatherMain}" class="icon">-->
<!--            <div class="weather-info">-->
<!--              <p>${currentWeatherMain}</p>-->
<!--              <p>${currentTemp} &#8451;</p>-->
<!--            </div>-->
<!--          </div>-->
<!--          <div class="dropdown">-->
<!--            <button class="dropbtn">Few Hours Forecast</button>-->
<!--            <div class="dropdown-content">-->
<!--              ${forecast.slice(0, 6).map((data) => {-->
<!--                const time = new Date(data.dt * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });-->
<!--                const temp = data.main.temp;-->
<!--                const weatherMain = data.weather[0].main;-->
<!--                const weatherIcon = data.weather[0].icon;-->
<!--                return `-->
<!--                  <div class="weather-content">-->
<!--                    <div>${time}</div>-->
<!--                    <img src="https://openweathermap.org/img/wn/${weatherIcon}.png" alt="${weatherMain}" class="small-icon">-->
<!--                    <div>${temp} &#8451;, ${weatherMain}</div>-->
<!--                  </div>-->
<!--                `;-->
<!--              }).join('')}-->
<!--            </div>-->
<!--          </div>-->
<!--          <div class="dropdown">-->
<!--            <button class="dropbtn">More Details</button>-->
<!--            <div class="dropdown-content">-->
<!--              <a href="#">Temperature: ${currentTemp} &#8451;</a>-->
<!--              <a href="#" class="details">Feels Like: ${forecast[0].main.feels_like} &#8451;</a>-->
<!--              <a href="#" class="details">Humidity: ${forecast[0].main.humidity}%</a>-->
<!--              <a href="#" class="details">Wind Direction: ${forecast[0].wind.deg} deg</a>-->
<!--              <a href="#" class="details">Wind Speed: ${forecast[0].wind.speed} m/s</a>-->
<!--            </div>-->
<!--          </div>-->
<!--          <div class="dropdown">-->
<!--            <button class="dropbtn">5-Day Forecast</button>-->
<!--            <div class="dropdown-content">-->
<!--              ${forecast.map((data, index) => {-->
<!--                if (index % 8 === 0) {-->
<!--                  const date = new Date(data.dt_txt).toLocaleDateString();-->
<!--                  const temp = data.main.temp;-->
<!--                  const weatherMain = data.weather[0].main;-->
<!--                  const weatherIcon = data.weather[0].icon;-->
<!--                  return `-->
<!--                    <a href="#" class="weather-date">${date}</a>-->
<!--                    <div class="weather-content">-->
<!--                      <img src="https://openweathermap.org/img/wn/${weatherIcon}.png" alt="${weatherMain}" class="small-icon">-->
<!--                      <a href="#" class="details">Temperature: ${temp} &#8451;</a>-->
<!--                      <a href="#" class="details">Weather: ${weatherMain}</a>-->
<!--                    </div>-->
<!--                  `;-->
<!--                }-->
<!--              }).join('')}-->
<!--            </div>-->
<!--          </div>-->
<!--        </div>`;-->

<!--      const dropdowns = document.querySelectorAll(".dropdown");-->
<!--      const details = document.querySelectorAll(".details");-->

<!--      dropdowns.forEach(dropdown => {-->
<!--        dropdown.addEventListener("click", function() {-->
<!--          this.nextElementSibling.classList.toggle("show");-->
<!--        });-->
<!--      });-->

<!--      details.forEach(detail => {-->
<!--        detail.addEventListener("click", function(event) {-->
<!--          event.stopPropagation();-->
<!--        });-->
<!--      });-->

<!--      window.onclick = function(event) {-->
<!--        if (!event.target.matches('.dropbtn')) {-->
<!--          const dropdownContent = document.querySelectorAll(".dropdown-content");-->
<!--          dropdownContent.forEach(content => {-->
<!--            if (content.classList.contains('show')) {-->
<!--              content.classList.remove('show');-->
<!--            }-->
<!--          });-->
<!--        }-->
<!--      };-->
<!--    });-->
<!--}-->

<!--This function is to draw heatmap on the Google Map-->
function drawHeatmap(checkbox) {
    console.log('clicked checkbox-1', checkbox, checkbox.checked);
    checked = checkbox.checked;
    if (checked) {
      if (heatmap == null) {
        // Fetch the data from the server
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function() {
          if (xhr.readyState == XMLHttpRequest.DONE) {
            if (xhr.status == 200) {
              console.log('data', xhr.responseText);
              var heatmapData = [];
              var data = JSON.parse(xhr.responseText).data;
              data.forEach(function(row) {
                heatmapData.push({
                  location: new google.maps.LatLng(row.position_lat, row.position_lng),
                  weight: row.available_bikes
                });
              });
              heatmap = new google.maps.visualization.HeatmapLayer({
                data: heatmapData,
                map: map
              });
              console.log(heatmap);
              heatmap.setMap(map);
              heatmap.set('radius', 40);
            } else {
              console.log('failed');
            }
          }
        }
        xhr.open('GET', '/heatmap', true);
        xhr.send(null);
      } else {
        heatmap.setMap(map);
      }
    } else {
      heatmap.setMap(null);
    }
  }



</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAjeRpg6GHEMrW0F-SVb08DJ5X2_0vOiYY&callback=myMap"></script>

</body>
</html>